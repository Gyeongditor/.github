name: Reusable PR AI Review

on:
  workflow_call:
    inputs:
      model:
        description: "ê¸°ë³¸ ëª¨ë¸"
        required: false
        type: string
        default: "gpt-4.1-mini"
      run_on_fork:
        description: "í¬í¬ PRì—ì„œë„ ì‹¤í–‰"
        required: false
        type: boolean
        default: false
      max_patch_per_file:
        description: "íŒŒì¼ë‹¹ patch ìµœëŒ€ ê¸¸ì´(ë¬¸ì)"
        required: false
        type: number
        default: 4000

permissions:
  contents: read
  pull-requests: write

jobs:
  guard-fork:
    runs-on: ubuntu-latest
    if: ${{ github.event.pull_request.head.repo.fork && inputs.run_on_fork == false }}
    steps:
      - uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ğŸ”’ ë³´ì•ˆìƒ í¬í¬ PRì—ì„œëŠ” AI ì½”ë“œë¦¬ë·°ê°€ ìë™ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. í•„ìš” ì‹œ Maintainerê°€ ë‚´ë¶€ ë¸Œëœì¹˜ì—ì„œ ì¬ì˜¤í”ˆí•˜ê±°ë‚˜ `run_on_fork: true`ë¡œ í˜¸ì¶œí•˜ì„¸ìš”."
            });

  review:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    if: ${{ !(github.event.pull_request.head.repo.fork && inputs.run_on_fork == false) }}
    concurrency:
      group: ${{ github.repository }}-ai-review-pr-${{ github.event.pull_request.number }}
      cancel-in-progress: true
    steps:
      - name: Checkout target repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: AI Review (summary comment)
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MODEL_DEFAULT: ${{ inputs.model }}
          MAX_PATCH_PER_FILE: ${{ inputs.max_patch_per_file }}
        with:
          script: |
            const pr = context.payload.pull_request;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const pull_number = pr.number;

            // 1) ë³€ê²½ íŒŒì¼ ëª©ë¡(+patch) ìˆ˜ì§‘
            const files = await github.paginate(github.rest.pulls.listFiles, { owner, repo, pull_number });
            const maxPerFile = Number(process.env.MAX_PATCH_PER_FILE || 4000);
            const binRe = /\.(png|jpg|jpeg|gif|svg|webp|mp4|mov|mp3|wav|zip|tgz|gz|pdf|ico)$/i;
            const lockRe = /(package-lock\.json|pnpm-lock\.yaml|yarn\.lock)$/i;

            const diffs = [];
            let rn=false, sb=false, fa=false;

            for (const f of files) {
              const path = (f.filename || "").toLowerCase();
              if (binRe.test(path) || lockRe.test(path)) continue;
              if (!f.patch) continue;

              if (/\.(tsx|jsx|ts|js)$/.test(path) || path.startsWith("android/") || path.startsWith("ios/")) rn = true;
              if (/\.(java|kt|xml)$/.test(path) || /(pom\.xml|build\.gradle(\.kts)?$)/.test(path) || path.includes("src/main/")) sb = true;
              if (/\.py$/.test(path) || /(requirements\.txt|pyproject\.toml)$/.test(path)) fa = true;

              const patch = String(f.patch).slice(0, maxPerFile);
              diffs.push(`# ${f.filename}\n\`\`\`diff\n${patch}\n\`\`\``);
            }

            if (diffs.length === 0) {
              await github.rest.issues.createComment({
                owner, repo, issue_number: pull_number,
                body: "â„¹ï¸ ë³€ê²½ëœ ì½”ë“œ íŒ¨ì¹˜ê°€ ì—†ê±°ë‚˜(ë˜ëŠ” ì „ë¶€ ë¬´ì‹œë¨) ë¦¬ë·°ê°€ ìƒëµë˜ì—ˆìŠµë‹ˆë‹¤."
              });
              return;
            }

            // 2) ìŠ¤íƒë³„ ê°€ì´ë“œ ê²°í•©
            const shared = [
              "You are a senior software engineer reviewing a pull request.",
              "Output sections: 1) Summary 2) Critical issues (with minimal diff patches) 3) Major 4) Minor 5) Tests 6) Security/Performance.",
              "Review only changed hunks; avoid restating the diff. Be specific and actionable.",
              "If context is missing or the diff was truncated, state assumptions briefly.",
              "Keep it concise (â‰ˆ250â€“400 words total).",
              "Always respond in Korean."
            ].join("\n");

            const rnGuide = rn ? [
              "React Native â€” FSD/Emotion-Native checklist",
              "- Follow FSD boundaries under src/: app=routes/layout only; shared=reusable(ui/hooks/lib) only; entities=domain-only; features=compose entities+shared; widgets=UI composition.",
              "- Modularize repeated logic/components: extract to shared/ui, shared/hooks, or shared/lib; prefer small, reusable utilities/components.",
              "- Styling (@emotion/native): use styled components with theme tokens and simple variant props (e.g., <Button primary />); compose with React Native style arrays ([base, cond && extra]); avoid recreating style objects inside render when possible; keep styles co-located but separate from business logic.",
              "- Error handling: avoid blanket try/catch; implement and reuse a central error handler/hook that logs safely (no PII) and surfaces clear, user-facing messages.",
              "Prioritize high-impact findings; avoid nitpicks that donâ€™t affect correctness or clarity.",
            ].join("\n") : "";

            const sbGuide = sb ? [
              "### Spring Boot ê°€ì´ë“œ",
              "### Spring Boot ì½”ë“œë¦¬ë·° ê°€ì´ë“œ",
            "",
            "#### 1) êµ¬ì¡°/ê²½ê³„",
            "- Controller â‡¢ DTO ë³€í™˜Â·ì…ë ¥ ê²€ì¦ ì¤‘ì‹¬, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì€ Service.",
            "- Service â‡¢ ìœ ìŠ¤ì¼€ì´ìŠ¤Â·íŠ¸ëœì­ì…˜ ê²½ê³„. Repository â‡¢ ìˆœìˆ˜ DB ì ‘ê·¼.",
            "- ìˆœí™˜ ì˜ì¡´ ê¸ˆì§€, ë„ë©”ì¸/ì• í”Œë¦¬ì¼€ì´ì…˜ ê²½ê³„ ëª…í™•í™”.",
            "",
            "#### 2) íŠ¸ëœì­ì…˜",
            "- `@Transactional`ì€ Serviceì— ì„ ì–¸: ê¸°ë³¸ `readOnly=true`, ì“°ê¸° ì‘ì—…ì—ë§Œ ì“°ê¸° íŠ¸ëœì­ì…˜.",
            "- ì „íŒŒ: ê¸°ë³¸ `REQUIRED`, ë¶„ë¦¬ í•„ìš” ì‹œ `REQUIRES_NEW`. self-invocation ì´ìŠˆ ì£¼ì˜.",
            "- ê¸´ íŠ¸ëœì­ì…˜ ë‚´ë¶€ì—ì„œ ì™¸ë¶€ I/O ê¸ˆì§€(íƒ€ì„ì•„ì›ƒÂ·ë½ êµì°© ìœ„í—˜).",
            "",
            "#### 3) ê²€ì¦",
            "- `@Valid/@Validated` ì‚¬ìš©, ë°”ì¸ë”©/ê²€ì¦ ì‹¤íŒ¨ëŠ” `@ControllerAdvice`ë¡œ í‘œì¤€ ì˜¤ë¥˜ ë³€í™˜.",
            "- ì…ë ¥ DTOì— ì œì•½ ëª…ì‹œ(ê¸¸ì´/íŒ¨í„´/ë²”ìœ„), ì„œë²„ë‹¨ ì¬ê²€ì¦ í•„ìˆ˜.",
            "",
            "#### 4) ì˜ˆì™¸ & try-catch",
            "- ê´‘ë²”ìœ„ `catch (Exception)` ì§€ì–‘. íšŒë³µ ê°€ëŠ¥/ë¶ˆê°€ëŠ¥ ì˜ˆì™¸ êµ¬ë¶„.",
            "- ì˜ˆì™¸ ì‚¼í‚¤ì§€ ë§ ê²ƒ: *ë¡œê·¸ + ë„ë©”ì¸ ì˜ˆì™¸ ë³€í™˜* (`ErrorCode`, `ApiResponseDTO`).",
            "- ë™ì¼ ì˜ˆì™¸ ë‹¤ì¤‘ ë¡œê¹… ê¸ˆì§€(ìŠ¤íƒíŠ¸ë ˆì´ìŠ¤ëŠ” í•œ ë²ˆ). ë¡œê·¸ ë ˆë²¨ ê¸°ì¤€ í•©ì˜ ì¤€ìˆ˜.",
            "- ìì› ê´€ë¦¬: íŒŒì¼/ìŠ¤íŠ¸ë¦¼/ì»¤ì„œ ë“±ì€ *try-with-resources*ë¡œ í™•ì‹¤íˆ ë‹«ê¸°.",
            "- `finally`ì—ì„œ íŠ¸ëœì­ì…˜ ì œì–´ ê¸ˆì§€(ë¡¤ë°±/ì»¤ë°‹ X).",
            "- ì™¸ë¶€í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ì›ì¸(`status/body`)ì„ ë³´ì¡´í•´ ë˜í•‘, ë¯¼ê°ì •ë³´ëŠ” ë§ˆìŠ¤í‚¹.",
            "- ìƒ˜í”Œ: `try { ... } catch (SpecificEx e) { log.warn(\"...\", e); throw new CustomException(ErrorCode.XYZ, e); }`",
            "",
            "#### 5) ë°ì´í„° ì ‘ê·¼/JPA (N+1/Lazy)",
            "- N+1 íƒì§€: fetch join / `@EntityGraph` / `hibernate.default_batch_fetch_size`.",
            "- DTO í”„ë¡œì ì…˜ ì ê·¹ ì‚¬ìš©. í˜ì´ì§• ì‹œ count ì¿¼ë¦¬/ì„±ëŠ¥ ê²€ì¦.",
            "- íŠ¸ëœì­ì…˜ ê²½ê³„ ë°– ì§€ì—° ë¡œë”© ê¸ˆì§€. ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸Â·`equals/hashCode` ê·œì¹™ ì¤€ìˆ˜.",
            "- ì¸ë±ìŠ¤/ìœ ë‹ˆí¬ ì œì•½ì€ DDLë¡œ ëª…ì‹œ(Flyway/Liquibase).",
            "",
            "#### 6) ì™¸ë¶€í˜¸ì¶œ/íšŒë³µíƒ„ë ¥ì„±",
            "- WebClient/RestTemplate: connect/read íƒ€ì„ì•„ì›ƒ í•„ìˆ˜.",
            "- Resilience4j: CircuitBreaker/Retry(ì§€ìˆ˜ ë°±ì˜¤í”„)/RateLimiter/Bulkhead ì ìš© ê·¼ê±° í™•ì¸.",
            "- ì¬ì‹œë„ëŠ” ë©±ë“± ì—°ì‚°ì—ë§Œ. ì¬ì‹œë„ ê°„ ìµœëŒ€ ëŒ€ê¸°/ì‹œë„ ìˆ˜ ì œí•œ.",
            "",
            "#### 7) ì¸ì¦/ì¸ê°€/ë³´ì•ˆ",
            "- SecurityFilterChainìœ¼ë¡œ ì¸ì¦/ì¸ê°€ ë¶„ë¦¬, `@PreAuthorize` ë“± ë©”ì„œë“œ ë³´ì•ˆ ë³‘í–‰.",
            "- í† í°Â·ë¹„ë°€ë²ˆí˜¸Â·í‚¤ ë“± ë¯¼ê°ì •ë³´ ë¡œê·¸ ê¸ˆì§€, í•„ë“œ ë§ˆìŠ¤í‚¹.",
            "- CORS ìµœì†Œí™”Â·ë³´ì•ˆ í—¤ë”(CSP/X-Content-Type-Options/Referrer-Policy) ê²€í† .",
            "",
            "#### 8) ë¡œê·¸/ê´€ì¸¡ì„±",
            "- MDC(ìš”ì²­ID/ì‚¬ìš©ìID) ì„¤ì •, ë‹¨ê³„ë³„ ë ˆë²¨ ì •ì±…(TRACE/DEBUG/INFO/WARN/ERROR).",
            "- Micrometer ë©”íŠ¸ë¦­/íŠ¸ë ˆì´ì‹±, ìŠ¬ë¡œìš°ì¿¼ë¦¬Â·GC ëª¨ë‹ˆí„°ë§ ì²´í¬.",
            "",
            "#### 9) ì„¤ì •/í”„ë¡œíŒŒì¼",
            "- `application-{dev,stage,prod}.yml` ë¶„ë¦¬, ë¹„ë°€ì€ í™˜ê²½ë³€ìˆ˜/Secrets Manager.",
            "- `@ConfigurationProperties` ì‚¬ìš©, í•˜ë“œì½”ë”©/ë§¤ì§ë„˜ë²„ ì œê±°.",
            "",
            "#### 10) API ê·œì•½",
            "- REST ìì›/ìƒíƒœì½”ë“œ ì¼ê´€ì„±, í‘œì¤€ ì‘ë‹µ(`ApiResponseDTO`)ê³¼ `ErrorCode` ë§¤í•‘.",
            "- í˜ì´ì§€ë„¤ì´ì…˜/ì •ë ¬/í•„í„° íŒŒë¼ë¯¸í„° í‘œì¤€í™”, ì…ë ¥ í¬ê¸° ì œí•œ, ì—…ë¡œë“œ `Content-Type` ê²€ì¦.",
            "- ë©±ë“±ì„± ë³´ì¥(ì¤‘ë³µìš”ì²­ ë°©ì§€ í‚¤/Idempotency-Key) ê³ ë ¤.",
            "",
            "#### 11) í…ŒìŠ¤íŠ¸/ë¬¸ì„œ",
            "- ë‹¨ìœ„(@ExtendWith), ìŠ¬ë¼ì´ìŠ¤(@DataJpaTest/@WebMvcTest), í†µí•©(Testcontainers) êµ¬ë¶„.",
            "- Given-When-Then ëª…í™•í™”, ê³ ë¦½ëœ ë‹¨ìœ„í…ŒìŠ¤íŠ¸ì—ì„œ ëª©/ìŠ¤í… êµ¬ë¶„.",
            "- OpenAPI(Swagger) ì£¼ì„/ì˜ˆì œ ë™ê¸°í™”, ì„±ê³µ/ì˜¤ë¥˜ ì˜ˆì‹œ í¬í•¨.",
            "",
            "#### 12) ì‹œê°„/êµ­ì œí™”",
            "- ì„œë²„/DBëŠ” UTC, í‘œí˜„ì€ Locale/Zone ëª…ì‹œ(`ZonedDateTime`). í¬ë§· ì¼ê´€ì„±.",
            "",
            "#### 13) ë¦¬ë·° ì¶œë ¥ í¬ë§·(í”¼ë“œë°± í†¤)",
            "- ğŸ”´ Critical | ğŸŸ¡ Improvement | ğŸŸ¢ Nitpick",
            "- ìˆ˜ì • ì „/í›„ ì½”ë“œ ìŠ¤ë‹ˆí« + ê·¼ê±°(ê°€ì´ë“œ/ë ˆí¼ëŸ°ìŠ¤) í•¨ê»˜ ì œì‹œ.",
            "",
            "#### 14) ì¶œë ¥ëŸ‰ ì œí•œ",
            "- ë¦¬ë·°ê°€ ë„ˆë¬´ ê¸¸ì–´ì§ˆ ê²½ìš° **í•µì‹¬ ì´ìŠˆ ì¤‘ì‹¬ ìš”ì•½**ìœ¼ë¡œ ë‹µë³€.",
            "- ê° ì„¹ì…˜ë‹¹ 2~3ì¤„ ìš”ì•½ ê¶Œì¥, ë¶ˆí•„ìš”í•œ ë°˜ë³µì€ ìƒëµ.",
            ].join("\n") : "";

            const faGuide = fa ? [
              "FastAPI â€” Starter rules",
              "- Thin routers â†’ services â†’ models; Pydantic at I/O edges.",
              "- Depends for db/session/settings; no globals.",
              "- Central exception handlers; no blanket try/except.",
              "- DB session per request; avoid N+1; paginate.",
              "- Auth/CORS/limits; no secrets/PII in logs.",
              "- Env config; DEBUG off in prod.",
              "Prioritize high-impact findings; skip non-blocking nits."
            ].join("\n") : "";

            const nestGuide = [
              "- Structure: Keep features isolated: `/src/<feature>/{module,controller,service,dto}`. Controllers stay thin (binding/auth/validation only); business logic lives in services. Use DTO barrel exports and avoid cross-feature imports.",
              "- Types & Style: Strict TypeScript, avoid `any`, declare return types, keep functions small, extract pure helpers.",
              "",
              "Validation & Upload",
              "- Enable global `ValidationPipe({ transform:true, whitelist:true, forbidNonWhitelisted:true })`.",
              "- File upload: `@UseInterceptors(FileInterceptor('audio', { limits:{ fileSize: 25*1024*1024 } }))`.",
              "- Add `ParseFilePipe` with `MaxFileSizeValidator(25MB)` and `FileTypeValidator` for `audio/wav|mpeg|mp4|x-m4a|flac`.",
              "- Map oversize to **413** and unsupported media to **415**. Text fields in multipart arrive via `@Body()` DTO.",
              "",
              "Config & Secrets",
              "- Use `@nestjs/config` with schema validation (zod/joi). Do not read `process.env` directly in business code.",
              "- Start with deny-by-default CORS; allow-list per environment. Apply `helmet` for common security headers.",
              "",
              "External Calls (OpenAI) & Resilience",
              "- Inject the OpenAI SDK via a singleton provider; never `new` it inside services.",
              "- Use `toFile(buffer, originalname, { type: mimetype })`. Default model: `gpt-4o-mini-transcribe`; expose `language`, `prompt`, `model` as options.",
              "- Set timeouts and exponential backoff for **429/5xx**; map failures to safe `HttpException`s.",
              "- Keep response shape stable: `{ text, durationMs?, model? }` (trim text; guard against null).",
              "",
              "Swagger (Practical)",
              "- Build with title/description/version and a `servers` entry (e.g., `http://localhost:3000`).",
              "- Security: `.addSecurity('ApiKeyAuth', { type:'apiKey', in:'header', name:'x-api-key' }).addSecurityRequirements('ApiKeyAuth')` (or `.addBearerAuth()` if using JWT).",
              "- Uploads: `@ApiConsumes('multipart/form-data')` + `@ApiBody({ type: SttUploadReqDto })`.",
              "- Responses: `@ApiOkResponse({ type: SttResDto, description: 'Transcription success', examples: { default: { value: { text: 'Hello', durationMs: 532, model: 'gpt-4o-mini-transcribe' }}}})`.",
              "- UI: enable `persistAuthorization`, set `tagsSorter/operationsSorter='alpha'`, and expose `/openapi.json`."
            ].join("\n");


            const guide = [shared, rnGuide, sbGuide, faGuide, nestGuide].filter(Boolean).join("\n\n");

            // 3) ëª¨ë¸ ì„ íƒ(ë ˆì´ë¸”ì— deep ë¼ë²¨ ìˆìœ¼ë©´ ìƒí–¥)
            const labels = (pr.labels || []).map(l => l.name);
            const deep = labels.includes(process.env.DEEP_LABEL || "ai:deep");
            const model = deep ? (process.env.MODEL_ESCALATE || "gpt-4.1") : (process.env.MODEL_DEFAULT || "gpt-4.1-mini");

            // 4) í”„ë¡¬í”„íŠ¸ ì¤€ë¹„
            const system = [
              "You are a senior engineer performing a strict but helpful PR review.",
              "Return sections: 1) Summary 2) Major issues (with suggested diffs) 3) Minor nits 4) Tests 5) Security/Performance.",
              "Comment **only** on changed hunks. Be concise and actionable."
            ].join("\n");

            const user = [
              `Repo: ${owner}/${repo}`,
              `PR #${pull_number} | ${pr.title}`,
              ``,
              guide,
              ``,
              `### PR Description`,
              `${pr.body || "(no description)"}`,
              ``,
              `### Changed hunks`,
              diffs.join("\n\n")
            ].join("\n");

            // 5) OpenAI í˜¸ì¶œ
            if (!process.env.OPENAI_API_KEY) {
              core.setFailed("OPENAI_API_KEY secretì´ ì—†ìŠµë‹ˆë‹¤.");
              return;
            }

            const res = await fetch("https://api.openai.com/v1/chat/completions", {
              method: "POST",
              headers: {
                "Authorization": `Bearer ${process.env.OPENAI_API_KEY}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model,
                messages: [
                  { role: "system", content: system },
                  { role: "user", content: user }
                ]
              })
            });

            if (!res.ok) {
              const errTxt = await res.text();
              core.setFailed(`OpenAI API error: ${res.status} ${errTxt}`);
              return;
            }
            const data = await res.json();
            const text = data.choices?.[0]?.message?.content || "AI reviewer produced no output.";

            // 6) ë¦¬ë·° ì½”ë©˜íŠ¸ ê²Œì‹œ(ë‹¨ì¼ ìš”ì•½)
            const body = `### ğŸ¤– AI Code Review (${model})\n\n${text}`.slice(0, 65000);
            await github.rest.pulls.createReview({
              owner, repo, pull_number,
              event: "COMMENT",
              body
            });
            core.info("AI review posted.");
